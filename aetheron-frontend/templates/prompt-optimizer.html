{% extends "base.html" %}
{% block title %}AI Prompt Optimizer â€“ Aetheron{% endblock %}

{% block content %}
<h1 class="text-4xl font-bold mb-4 text-cyan-400">AI Prompt Optimizer</h1>
<p class="text-gray-400 mb-6">Enter messy prompt text below to optimize it for structured, agent-ready usage.</p>

<textarea id="input" rows="6" class="w-full p-4 rounded bg-gray-800 text-white mb-4" placeholder="Type your unstructured prompt..."></textarea>

<div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-4">
  <div>
    <label for="format" class="text-gray-300 mr-2 font-medium">Output format:</label>
    <select id="format" name="format" class="bg-gray-800 text-white p-2 rounded border border-gray-700">
      <option value="pdf">ğŸ“˜ Premium PDF (.pdf)</option>
      <option value="txt">ğŸ“„ Plain Text (.txt)</option>
    </select>
  </div>

  <button onclick="submitPrompt()" class="bg-cyan-500 text-black px-4 py-2 rounded hover:bg-cyan-400 font-semibold">
    ğŸ’¡ Optimize Prompt
  </button>
</div>

<div id="result" class="mt-6 bg-gray-800 p-4 rounded hidden whitespace-pre-wrap"></div>

<div id="actions" class="mt-4 hidden flex gap-4">
  <button onclick="copyToClipboard()" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-600">ğŸ“‹ Copy</button>
  <button onclick="downloadAsTxt()" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-600">ğŸ“¥ Download .txt</button>
</div>

<script>
  let optimizedText = "";

  async function submitPrompt() {
    const input = document.getElementById("input").value.trim();
    const resultBox = document.getElementById("result");
    const actions = document.getElementById("actions");

    resultBox.innerHTML = "â³ Optimizing...";
    resultBox.classList.remove("hidden");
    actions.classList.add("hidden");

    const userWallet = window.userWallet || localStorage.getItem("connectedWallet") || "";
    if (!userWallet) {
      resultBox.innerHTML = "âŒ Connect your wallet first using the button above.";
      return;
    }

    const res = await fetch("/api/prompt-optimizer", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-WALLET": userWallet
      },
      body: JSON.stringify({
        text: input,
        format: document.getElementById("format").value
      }),
    });

    const data = await res.json();

    if (res.status === 200) {
      optimizedText = data.optimized_prompt;
      const fileLabel = data.format === "txt" ? "ğŸ“„ Download .txt" : "ğŸ“˜ Download .pdf";
      resultBox.innerHTML = `
        <p class="text-cyan-400 font-semibold mb-2">âœ… Deliverable ready:</p>
        <a href="${data.download_url}" target="_blank" class="underline text-cyan-300">${fileLabel}</a>
      `;
      actions.classList.remove("hidden");
      window.open(data.download_url, "_blank");
    }
    else if (res.status === 402) {
      resultBox.innerHTML = "ğŸ’° Payment required. Please complete the transaction in your wallet and try again.";
    }
    else {
      resultBox.innerHTML = `<div class="text-red-400">âŒ ${data.message}</div><pre class="text-xs mt-2">${JSON.stringify(data, null, 2)}</pre>`;
    }
  }

  function copyToClipboard() {
    navigator.clipboard.writeText(optimizedText).then(() => {
      alert("âœ… Optimized prompt copied to clipboard!");
    });
  }

  function downloadAsTxt() {
    const blob = new Blob([optimizedText], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.download = "optimized_prompt.txt";
    link.href = url;
    link.click();
    URL.revokeObjectURL(url);
  }
</script>
{% endblock %}