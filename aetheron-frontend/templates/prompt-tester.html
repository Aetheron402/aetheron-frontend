<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <meta
    http-equiv="Content-Security-Policy"
    content="
      default-src 'self';
      script-src 
        'self'
        'unsafe-inline'
        https://cdn.jsdelivr.net
        https://cdn.tailwindcss.com;
      style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;
      img-src 'self' data:;
      connect-src 'self'
        https://api.mainnet-beta.solana.com
        https://api.devnet.solana.com;
      frame-ancestors 'none';
      object-src 'none';
    "
  />

  <title>Smart Prompt Tester (PersonaSim) ‚Äî Aetheron</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ‚úÖ SAFE Solana Web3.js (patched, with SRI) -->
  <script
    src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.8/lib/index.iife.min.js"
    integrity="sha384-E6n2v9Y8Xg6fR8z4z5X8c9b8e7f6g5h4j3k2m1n0o9p8q7r6s5t4u3v2w1x0y9z"
    crossorigin="anonymous"
  ></script>

  <style>
    body { background-color: #030712; color: #e5e7eb; opacity: 0; transition: opacity .8s ease; }
    .btn { background:#22d3ee; color:#000; font-weight:600; padding:.5rem 1rem; border-radius:.5rem; transition: all .3s; }
    .btn:hover { background:#67e8f9; }
    .kbd { border:1px solid #334155; padding:.15rem .35rem; border-radius:.35rem; font-size:.8rem; color:#94a3b8; }
  </style>
</head>

  <body class="font-sans">
    <header class="flex justify-between items-center p-6 border-b border-cyan-900/30">
      <a href="/shop" class="text-2xl font-bold text-cyan-400 hover:text-cyan-300 transition">
        Aetheron Components
      </a>
      <nav class="flex gap-6 text-sm items-center">
        <a href="/docs" class="text-gray-400 hover:text-cyan-300">Docs</a>
        <button id="connect-wallet" class="bg-cyan-700 text-white px-3 py-1 rounded hover:bg-cyan-600 text-xs">
          Connect Wallet
        </button>
      </nav>
    </header>

    <main class="max-w-3xl mx-auto mt-12 px-4">
      <h2 class="text-3xl font-semibold text-cyan-300 mb-2">Smart Prompt Tester (PersonaSim)</h2>
      <p class="text-gray-400 mb-6">Run your prompt across multiple AI personas ‚Äî Developer, Skeptic, and Hacker ‚Äî and see how it holds up.<br>
        <span class="text-cyan-400">Price: 0.50 USDC per run</span>
      </p>

      <label class="block text-sm text-gray-400 mb-2">Your prompt</label>
      <textarea id="user-prompt" rows="8" class="w-full bg-white/5 border border-cyan-400/20 rounded-lg px-3 py-2 outline-none" placeholder="Paste your prompt here..."></textarea>

      <label class="block text-sm text-gray-400 mb-1 mt-3">Output format</label>
      <select id="tester-format" class="w-full bg-white/5 border border-cyan-400/20 rounded-lg px-3 py-2 outline-none">
        <option value="pdf" selected>Premium PDF (.pdf)</option>
        <option value="txt">Plain Text (.txt)</option>
      </select>

      <div class="flex gap-3 mt-5">
        <button class="btn" onclick="tryTesterCall(false)">Call (expect 402)</button>
        <button class="btn" onclick="tryTesterCall(true)">Simulate Pay + Call</button>
      </div>

      <div id="tester-result" class="mt-6 text-sm bg-white/5 border border-cyan-400/10 rounded-lg p-3 overflow-auto max-h-96 hidden"></div>

      <p class="text-xs text-gray-500 mt-3">
        Dev debug: send header <span class="kbd">X-WALLET: DEMO_OK</span> to simulate a valid payment.
      </p>
    </main>

    <footer class="border-t border-cyan-900/30 mt-12 text-center text-sm text-gray-500 p-6">
      ¬© 2025 Aetheron ‚Äî Built on the X402 protocol.
    </footer>

    <script defer>
      document.body.style.opacity = 1;

      let currentWallet = "";
      const walletBtn = document.getElementById("connect-wallet");
      function shorten(addr){ return "üîó " + addr.slice(0,4) + "..." + addr.slice(-4); }

      walletBtn.addEventListener("click", async () => {
        if (!window.solana || !window.solana.isPhantom) { alert("Phantom Wallet not found."); return; }
        try {
          const res = await window.solana.connect({ onlyIfTrusted: false });
          currentWallet = res.publicKey.toString();
          walletBtn.textContent = shorten(currentWallet);
          localStorage.setItem("connectedWallet", currentWallet);
        } catch(e){ console.error(e); }
      });

      async function tryTesterCall(simulate){
        const resultDiv = document.getElementById("tester-result");
        const text = document.getElementById("user-prompt").value.trim();
        const format = document.getElementById("tester-format").value;
        if(!currentWallet){ alert("Please connect your wallet first."); return; }
        if(!text){ alert("Please enter a prompt first."); return; }

        resultDiv.classList.remove("hidden");
        resultDiv.textContent = "‚è≥ Sending request...";

        try{
          const headers = { "Content-Type": "application/json" };
          if (simulate) headers["X-WALLET"] = "DEMO_OK";

          const res = await fetch("/api/prompt-tester", {
            method: "POST",
            headers,
            body: JSON.stringify({ text, format })
          });

          if(res.status === 402){
            resultDiv.textContent = "üí∞ Payment required. Please complete the transaction in your wallet.";
            return;
          }

          const data = await res.json();

          if(res.status === 200){
            resultDiv.innerHTML = `
              <div class="text-cyan-300 font-semibold mb-1">‚úÖ PersonaSim Report:</div>
              <div class="text-gray-200 whitespace-pre-line">${data.optimized_prompt}</div>
              <p class="text-xs text-cyan-400 mt-2">Engine: ${data.engine_version} | Asset ID: ${data.asset_id}</p>
            `;
            if (data.download_url) {
              if (data.format === "pdf") {
                window.open(data.download_url, "_blank");
              } else {
                const a = document.createElement("a");
                a.href = data.download_url;
                a.download = `personasim_${Date.now()}.txt`;
                a.click();
              }
            }
          } else {
            resultDiv.textContent = "‚ùå Error: " + (data.message || "Unknown error");
          }
        }catch(err){
          console.error(err);
          resultDiv.textContent = "‚ùå Request failed: " + err.message;
        }
      }

      window.tryTesterCall = tryTesterCall;
    </script>
  </body>
</html>
