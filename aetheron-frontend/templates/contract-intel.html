{% extends "base.html" %}

{% block title %}Contract Intelligence Analyzer — Aetheron{% endblock %}

{% block body_class %}page-contract-intel{% endblock %}

{% block content %}

<main class="max-w-3xl mx-auto mt-12 px-4">

  <h2 class="text-3xl font-semibold text-cyan-300 mb-2">
    Contract Intelligence Analyzer
  </h2>

  <p class="text-gray-400 mb-6">
    Analyze any Solana or Ethereum contract.<br>
    <span class="text-cyan-400">Price: 1.00 USDC per scan</span>
  </p>

  <!-- Network -->
  <label class="block text-sm text-gray-400 mb-2">Select Network</label>
  <select id="network"
          class="w-full bg-white/5 border border-cyan-400/20 rounded-lg px-3 py-2 outline-none mb-4">
    <option value="solana">Solana</option>
    <option value="ethereum">Ethereum</option>
  </select>

  <!-- Address -->
  <label class="block text-sm text-gray-400 mb-2">Contract Address</label>
  <input
    id="contract-address"
    type="text"
    class="w-full bg-white/5 border border-cyan-400/20 rounded-lg px-3 py-2 outline-none"
    placeholder="Enter contract address…"
  />

  <!-- Format -->
  <label class="block text-sm text-gray-400 mb-1 mt-3">Output Format</label>
  <select id="intel-format"
          class="w-full bg-white/5 border border-cyan-400/20 rounded-lg px-3 py-2 outline-none">
    <option value="pdf" selected>Premium PDF (.pdf)</option>
    <option value="txt">Plain Text (.txt)</option>
  </select>

  <div class="flex gap-3 mt-5">
    <button class="btn" onclick="tryContractCall(false)">Call (expect 402)</button>
    <button class="btn" onclick="tryContractCall(true)">Simulate Pay + Call</button>
  </div>

  <div id="contract-result"
       class="mt-6 text-sm bg-white/5 border border-cyan-400/10 rounded-lg p-3
              overflow-auto max-h-96 hidden"></div>

  <p class="text-xs text-gray-500 mt-3">
    Dev debug: send header <span class="kbd">X-WALLET: DEMO_OK</span>
  </p>

</main>

{% endblock %}

{% block scripts %}
<script>
async function tryContractCall(simulate) {
  const resultDiv = document.getElementById("contract-result");
  const addrInput = document.getElementById("contract-address");

  let contractAddr = addrInput.value.trim();
  let cleanAddr = contractAddr
    .replace(/\s*(pump|bonk)$/i, "")

  const network = document.getElementById("network").value;
  const format = document.getElementById("intel-format").value;

  if (!window.currentWallet) {
    alert("Please connect your wallet first.");
    return;
  }

  if (!contractAddr) {
    alert("Please enter a contract address.");
    return;
  }

  resultDiv.classList.remove("hidden");
  resultDiv.textContent = "Sending request...";

  try {
    const headers = { "Content-Type": "application/json" };
    if (simulate) headers["X-WALLET"] = "DEMO_OK";

    const res = await fetch("/api/contract-intel", {
      method: "POST",
      headers,
      body: JSON.stringify({
        contract_address: cleanAddr,
        network: network,
        format: format
      })
    });

    const data = await res.json();

    if (res.status === 402) {
      resultDiv.textContent = "Payment required. Please complete the transaction.";
      return;
    }

    if (res.status === 202) {
      resultDiv.innerHTML = `
        <div class="text-cyan-300 font-semibold mb-1">Scan queued</div>
        <div class="text-gray-200">Task ID: ${data.task_id}</div>
      `;
    } else {
      resultDiv.textContent = "Error: " + (data.message || "Unknown error");
    }
  } catch (err) {
    console.error(err);
    resultDiv.textContent = "Request failed: " + err.message;
  }
}
</script>
{% endblock %}
